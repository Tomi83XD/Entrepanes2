import React, { useState, useEffect } from 'react';
import { db } from '../firebase.js'; // Importa db real (asegÃºrate de que firebase.js estÃ© configurado)
import { collection, query, onSnapshot, orderBy, addDoc, updateDoc, doc } from 'firebase/firestore'; // Importa funciones necesarias

function SocialButtons() {
  return (
    <div className="fixed bottom-6 left-6 z-50 flex flex-col gap-4">
      <a
        href="https://www.instagram.com/entrepanes_vcp/"
        target="_blank"
        rel="noopener noreferrer"
        className="bg-white p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-yellow-300"
        aria-label="SÃ­guenos en Instagram"
      >
        <span className="text-2xl">ğŸ“·</span>
      </a>
      <a
        href="https://www.tiktok.com/@entrepanes_vcp"
        target="_blank"
        rel="noopener noreferrer"
        className="bg-white p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-yellow-300"
        aria-label="SÃ­guenos en TikTok"
      >
        <span className="text-2xl">ğŸµ</span>
      </a>
    </div>
  );
}

function NotificationPopup({ message, type = 'success', onHide }) {
  useEffect(() => {
    const timer = setTimeout(() => {
      onHide();
    }, 3000);
    return () => clearTimeout(timer);
  }, [onHide]);

  const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-orange-500' : 'bg-red-500';
  const icon = type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ';

  return (
    <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 ${bgColor} text-white font-bold px-6 py-4 rounded-xl shadow-2xl z-50 animate-bounce select-none flex items-center gap-3`}>
      <span className="text-2xl">{icon}</span>
      <span>{message}</span>
    </div>
  );
}

function CategoryFilters({ categories, activeCategory, onSelectCategory }) {
  return (
    <div className="max-w-screen-xl mx-auto px-6 mb-8 sticky top-20 z-40 bg-yellow-700 py-4 rounded-xl shadow-lg">
      <div className="flex flex-wrap justify-center gap-3">
        <button
          onClick={() => onSelectCategory('all')}
          className={`px-6 py-3 rounded-full font-bold uppercase transition-all transform hover:scale-105 ${
            activeCategory === 'all'
              ? 'bg-yellow-500 text-yellow-900 shadow-lg scale-105'
              : 'bg-yellow-800/80 text-yellow-200 hover:bg-yellow-700'
          }`}
        >
          ğŸ½ï¸ Todos
        </button>
        
        {categories.map((cat) => (
          <button
            key={cat.id}
            onClick={() => onSelectCategory(cat.id)}
            className={`px-6 py-3 rounded-full font-bold uppercase transition-all transform hover:scale-105 ${
              activeCategory === cat.id
                ? 'bg-yellow-500 text-yellow-900 shadow-lg scale-105'
                : 'bg-yellow-800/80 text-yellow-200 hover:bg-yellow-700'
            }`}
          >
            {cat.icon} {cat.name}
          </button>
        ))}
      </div>
    </div>
  );
}

function StockBadge({ stock, limitedStock }) {
  if (stock === 0) {
    return (
      <div className="absolute top-3 left-3 bg-red-600 text-white font-bold px-3 py-2 rounded-full text-xs z-10 shadow-lg">
        ğŸš« Agotado
      </div>
    );
  }
  
  if (limitedStock && stock <= 5) {
    return (
      <div className="absolute top-3 left-3 bg-orange-500 text-white font-bold px-3 py-2 rounded-full text-xs z-10 shadow-lg animate-pulse">
        â° Â¡Ãšltimas {stock} unidades!
      </div>
    );
  }
  
  return null;
}

function CatalogSection({ title, items, addToCart, showTitle = true }) {
  if (items.length === 0) {
    return null;
  }

  return (
    <section
      className="max-w-screen-xl mx-auto px-6 py-8"
      aria-labelledby={`${title.toLowerCase().replace(/\s/g, '-')}-title`}
    >
      {showTitle && (
        <h2
          id={`${title.toLowerCase().replace(/\s/g, '-')}-title`}
          className="text-4xl font-extrabold text-white mb-8 select-none border-b-4 border-yellow-500 pb-3 inline-block"
        >
          {title}
        </h2>
      )}
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
        {items.map((item) => {
          const finalPrice = item.discount > 0 
            ? item.price - (item.price * item.discount / 100)
            : item.price;
          
          const isOutOfStock = item.stock === 0;
          const isLowStock = item.limitedStock && item.stock > 0 && item.stock <= 5;

          return (
            <article
              key={item.id}
              className={`bg-yellow-900/90 backdrop-blur-lg rounded-3xl shadow-xl overflow-hidden flex flex-col hover:shadow-2xl transition-all hover:scale-105 transform relative group ${isOutOfStock ? 'opacity-60' : ''}`}
            >
              {/* Badge de stock */}
              <StockBadge stock={item.stock} limitedStock={item.limitedStock} />
              
              {/* Badge de oferta */}
              {item.discount > 0 && !isOutOfStock && (
                <div className="absolute top-3 right-3 bg-red-500 text-white font-bold px-3 py-2 rounded-full text-xs z-10 shadow-lg animate-pulse">
                  -{item.discount}% OFF
                </div>
              )}
              
              {/* Badge de destacado */}
              {item.featured && !isOutOfStock && (
                <div className="absolute top-14 left-3 bg-gradient-to-r from-yellow-400 to-yellow-300 text-yellow-900 font-bold px-3 py-2 rounded-full text-xs z-10 shadow-lg">
                  â­ Destacado
                </div>
              )}

              {/* Badge de nuevo */}
              {item.isNew && !isOutOfStock && (
                <div className="absolute top-3 left-3 bg-gradient-to-r from-green-400 to-green-500 text-white font-bold px-3 py-2 rounded-full text-xs z-10 shadow-lg">
                  ğŸ†• Nuevo
                </div>
              )}

              <div className="relative overflow-hidden h-48">
                <img
                  src={item.image || 'https://via.placeholder.com/300x200?text=Sin+Imagen'}
                  alt={item.name}
                  className={`w-full h-full object-cover transition-transform duration-300 group-hover:scale-110 ${isOutOfStock ? 'grayscale' : ''}`}
                  loading="lazy"
                  onError={(e) => {
                    e.target.src = 'https://via.placeholder.com/300x200?text=Sin+Imagen';
                  }}
                />
                {isOutOfStock && (
                  <div className="absolute inset-0 bg-black/60 flex items-center justify-center">
                    <span className="text-white font-bold text-2xl">AGOTADO</span>
                  </div>
                )}
                <div className="absolute inset-0 bg-gradient-to-t from-yellow-900/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
              </div>

              <div className="p-5 flex flex-col flex-grow">
                <h3 className="text-xl font-bold text-yellow-100 mb-2 select-none">{item.name}</h3>
                {item.description && (
                  <p className="text-yellow-200 flex-grow text-sm mb-3 line-clamp-2">{item.description}</p>
                )}
                
                {/* Mostrar stock disponible */}
                {!isOutOfStock && item.limitedStock && (
                  <div className="mb-3">
                    <div className="flex items-center justify-between text-xs text-yellow-300 mb-1">
                      <span>Stock disponible</span>
                      <span className="font-bold">{item.stock} unidades</span>
                    </div>
                    <div className="w-full bg-yellow-700 rounded-full h-2">
                      <div 
                        className={`h-2 rounded-full transition-all ${
                          item.stock <= 3 ? 'bg-red-500' : 
                          item.stock <= 5 ? 'bg-orange-500' : 
                          'bg-green-500'
                        }`}
                        style={{ width: `${Math.min((item.stock / 10) * 100, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                )}
                
                <div className="mt-auto">
                  {item.discount > 0 ? (
                    <div className="flex items-center gap-2 mb-3">
                      <p className="font-extrabold text-2xl text-yellow-300 select-none">${finalPrice.toFixed(0)}</p>
                      <p className="text-sm text-yellow-400 line-through select-none">${item.price}</p>
                      <span className="ml-auto bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">
                        AhorrÃ¡s ${(item.price - finalPrice).toFixed(0)}
                      </span>
                    </div>
                  ) : (
                    <p className="font-extrabold text-2xl text-yellow-300 select-none mb-3">${item.price}</p>
                  )}
                  
                  <button
                    onClick={() => !isOutOfStock && addToCart({ ...item, finalPrice })}
                    type="button"
                    disabled={isOutOfStock}
                    className={`w-full font-bold uppercase rounded-xl py-3 shadow-lg transition-all transform focus:outline-none focus:ring-4 focus:ring-yellow-300 select-none ${
                      isOutOfStock 
                        ? 'bg-gray-500 text-gray-300 cursor-not-allowed' 
                        : 'bg-gradient-to-r from-yellow-500 to-yellow-400 hover:from-yellow-400 hover:to-yellow-300 text-yellow-900 hover:scale-105'
                    }`}
                  >
                    {isOutOfStock ? 'ğŸ˜¢ Agotado' : 'ğŸ›’ AÃ±adir al Carrito'}
                  </button>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  );
}

// Componente de Carrito mejorado
function Cart({ cartItems, onClose, onRemoveItem, onClearCart, onIncreaseQty, onDecreaseQty }) {
  const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  const sendWhatsAppOrder = () => {
    if (cartItems.length === 0) return;
    
    let message = "ğŸ›’ *Nuevo Pedido - Entrepanes VCP*\n\n";
    cartItems.forEach(item => {
      message += `â€¢ ${item.name}\n`;
      message += `  Cantidad: ${item.quantity}\n`;
      message += `  Precio: $${item.price} c/u\n`;
      message += `  Subtotal: $${(item.price * item.quantity).toFixed(0)}\n\n`;
    });
    message += `ğŸ’° *Total: $${total.toFixed(0)}*\n\n`;
    message += "ğŸ“ DirecciÃ³n de entrega:\n";
    message += "ğŸ• Horario preferido:\n";
    message += "ğŸ’³ Forma de pago:\n";
    
    const encodedMessage = encodeURIComponent(message);
    const whatsappURL = `https://wa.me/5493541682299?text=${encodedMessage}`;
    window.open(whatsappURL, '_blank');
  };

  return (
    <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className="p-6 border-b border-gray-200 flex items-center justify-between bg-yellow-500">
          <h2 className="text-2xl font-bold text-yellow-900">ğŸ›’ Tu Carrito</h2>
          <button onClick={onClose} className="text-yellow-900 hover:text-yellow-700 text-3xl">Ã—</button>
        </div>
        
        <div className="flex-1 overflow-y-auto p-6">
          {cartItems.length === 0 ? (
            <div className="text-center py-12">
              <span className="text-6xl mb-4 block">ğŸ›’</span>
              <p className="text-gray-500 text-lg">Tu carrito estÃ¡ vacÃ­o</p>
            </div>
          ) : (
            <div className="space-y-4">
              {cartItems.map(item => (
                <div key={item.id} className="flex gap-4 bg-gray-50 rounded-xl p-4">
                  <img src={item.image} alt={item.name} className="w-20 h-20 object-cover rounded-lg" />
                  <div className="flex-1">
                    <h3 className="font-bold text-gray-800">{item.name}</h3>
                    <p className="text-yellow-600 font-bold">${item.price}</p>
                    <div className="flex items-center gap-2 mt-2">
                      <button 
                        onClick={() => onDecreaseQty(item.id)}
                        className="bg-yellow-500 text-white w-8 h-8 rounded-full font-bold hover:bg-yellow-600"
                      >
                        -
                      </button>
                      <span className="font-bold text-gray-800 w-8 text-center">{item.quantity}</span>
                      <button 
                        onClick={() => onIncreaseQty(item.id)}
                        className="bg-yellow-500 text-white w-8 h-8 rounded-full font-bold hover:bg-yellow-600"
                      >
                        +
                      </button>
                      <button 
                        onClick={() => onRemoveItem(item.id)}
                        className="ml-auto text-red-500 hover:text-red-700 font-bold"
                      >
                        ğŸ—‘ï¸ Eliminar
                      </button>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-lg text-gray-800">${(item.price * item.quantity).toFixed(0)}</p>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        
        {cartItems.length > 0 && (
          <div className="p-6 border-t border-gray-200 bg-gray-50">
            <div className="flex justify-between items-center mb-4">
              <span className="text-xl font-bold text-gray-800">Total:</span>
              <span className="text-3xl font-bold text-yellow-600">${total.toFixed(0)}</span>
            </div>
            <button
              onClick={sendWhatsAppOrder}
              className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all mb-3"
            >
              ğŸ“± Enviar Pedido por WhatsApp
            </button>
            <button
              onClick={onClearCart}
              className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all"
            >
              ğŸ—‘ï¸ Vaciar Carrito
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

export default function Catalogo() {
  const [cartItems, setCartItems] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [notification, setNotification] = useState(null);
  const [menuItems, setMenuItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeCategory, setActiveCategory] = useState('all');

  const categories = [
    { id: 'featured', name: 'Destacados', icon: 'â­' },
    { id: 'miga', name: 'Migas', icon: 'ğŸ¥ª' },
    { id: 'pebete', name: 'Pebetes', icon: 'ğŸ”' },
    { id: 'bebidas', name: 'Bebidas', icon: 'ğŸ¥¤' },
    { id: 'postres', name: 'Postres', icon: 'ğŸ°' },
    { id: 'otros', name: 'Otros', icon: 'ğŸ“¦' }
  ];

  // Hook para cargar datos de Firestore
  useEffect(() => {
    const q = query(collection(db, 'menu'), orderBy('name')); // Ordena por nombre (puedes cambiar a otro campo si quieres)
    const unsubscribe = onSnapshot(q, (querySnapshot) => {
      const items = [];
      querySnapshot.forEach((docSnap) => {
        items.push({
          id: docSnap.id,
          name: docSnap.data().name || '',
          price: docSnap.data().price || 0,
          description: docSnap.data().description || '',
          image: docSnap.data().image || '',
          category: docSnap.data().category || 'miga',
          discount: docSnap.data().discount || 0,
          stock: docSnap.data().stock || 0,
          limitedStock: docSnap.data().limitedStock || false,
          featured: docSnap.data().featured || false,
          isNew: docSnap.data().isNew || false,
          isAvailable: docSnap.data().isAvailable !== false
        });
      });
      setMenuItems(items);
      setLoading(false);
    }, (error) => {
      console.error("Error al cargar el menÃº:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
  };

  const hideNotification = () => {
    setNotification(null);
  };

  const confirmSale = async (cartItems, total) => {
    try {
      // Registrar la venta en 'sales'
      const saleData = {
        date: new Date().toISOString().split('T')[0], // Fecha en formato YYYY-MM-DD
        items: cartItems.map(item => ({
          id: item.id,
          name: item.name,
          quantity: item.quantity,
          price: item.price,
          subtotal: item.price * item.quantity
        })),
        total: total,
        timestamp: new Date()
      };
      await addDoc(collection(db, 'sales'), saleData);

      // Disminuir stock en 'menu' para cada item
      for (const item of cartItems) {
        const itemRef = doc(db, 'menu', item.id);
        const currentStock = menuItems.find(m => m.id === item.id)?.stock || 0;
        const newStock = Math.max(0, currentStock - item.quantity); // Evita stock negativo
        await updateDoc(itemRef, { stock: newStock });
      }

      // Limpiar carrito despuÃ©s de confirmar
      setCartItems([]);
      setIsCartOpen(false);
      showNotification('Â¡Venta registrada y stock actualizado!', 'success');
    } catch (error) {
      console.error('Error al confirmar venta:', error);
      showNotification('Error al procesar la venta. IntÃ©ntalo de nuevo.', 'error');
    }
  };

  const addToCart = (item) => {
    // Verificar stock disponible
    const currentCartItem = cartItems.find(i => i.id === item.id);
    const currentQuantityInCart = currentCartItem ? currentCartItem.quantity : 0;
    
    if (currentQuantityInCart >= item.stock) {
      showNotification(`âš ï¸ No hay mÃ¡s stock de ${item.name}`, 'warning');
      return;
    }
    
    setCartItems((prevItems) => {
      const found = prevItems.find((i) => i.id === item.id); 
      if (found) {
        return prevItems.map((i) =>
          i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i
        );
      } else {
        return [...prevItems, { 
          ...item, 
          quantity: 1,
          price: item.finalPrice || item.price 
        }];
      }
    });
    showNotification('Â¡AÃ±adido al carrito!', 'success');
  };

  const removeItem = (id) => {
    setCartItems((prevItems) => prevItems.filter((item) => item.id !== id));
  };

  const clearCart = () => {
    setCartItems([]);
    setIsCartOpen(false);
  };

  const increaseQty = (id) => {
    const item = menuItems.find(i => i.id === id);
    const cartItem = cartItems.find(i => i.id === id);
    
    if (cartItem && cartItem.quantity >= item.stock) {
      showNotification(`âš ï¸ Stock mÃ¡ximo alcanzado para ${item.name}`, 'warning');
      return;
    }
    
    setCartItems((prevItems) =>
      prevItems.map((item) =>
        item.id === id ? { ...item, quantity: item.quantity + 1 } : item
      )
    );
  };

  const decreaseQty = (id) => {
    setCartItems((prevItems) =>
      prevItems
        .map((item) => {
          if (item.id === id) {
            const newQty = item.quantity - 1;
            return newQty > 0 ? { ...item, quantity: newQty } : null;
          }
          return item;
        })
        .filter((item) => item !== null)
    );
  };

  const toggleCart = () => {
    setIsCartOpen(!isCartOpen);
  };

  const totalQuantity = cartItems.reduce((sum, item) => sum + item.quantity, 0);

  const getFilteredItems = () => {
    if (activeCategory === 'all') {
      return menuItems;
    }
    if (activeCategory === 'featured') {
      return menuItems.filter(item => item.featured);
    }
    return menuItems.filter(item => item.category === activeCategory);
  };

  const filteredItems = getFilteredItems();

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-yellow-700">
        <div className="text-white text-2xl font-semibold animate-pulse">ğŸ Cargando catÃ¡logo delicioso...</div>
      </div>
    );
  }

  return (
    <main className="min-h-screen bg-gradient-to-br from-yellow-700 via-yellow-600 to-yellow-800 pt-20 pb-12 px-4 relative">
      <div className="text-center mb-8">
        <h1 className="text-5xl md:text-6xl font-serif font-extrabold text-white drop-shadow-2xl mb-4 select-none animate-fade-in">
          ğŸ Nuestro CatÃ¡logo ğŸ
        </h1>
        <p className="text-yellow-200 text-lg md:text-xl font-medium select-none">
          Los mejores sÃ¡ndwiches de Carlos Paz te esperan
        </p>
      </div>

      <button
        onClick={toggleCart}
        className="fixed top-6 right-6 bg-yellow-500 text-yellow-900 font-bold px-5 py-3 rounded-full shadow-2xl hover:bg-yellow-400 transition-all transform hover:scale-110 z-50 flex items-center gap-2 focus:outline-none focus:ring-4 focus:ring-yellow-300"
        aria-label="Abrir carrito de compras"
      >
        <span className="text-2xl">ğŸ›’</span>
        {totalQuantity > 0 && (
          <span className="text-yellow-900 bg-yellow-300 px-3 py-1 rounded-full font-bold text-sm select-none animate-pulse">
            {totalQuantity}
          </span>
        )}
      </button>

      <CategoryFilters 
        categories={categories} 
        activeCategory={activeCategory} 
        onSelectCategory={setActiveCategory} 
      />

      {filteredItems.length > 0 ? (
        <CatalogSection 
          title={activeCategory === 'all' ? 'Todos los Productos' : categories.find(c => c.id === activeCategory)?.name || 'Productos'} 
          items={filteredItems} 
          addToCart={addToCart}
          showTitle={false}
        />
      ) : (
        <div className="text-center text-white text-xl py-20 bg-yellow-800/50 rounded-3xl max-w-2xl mx-auto">
          <span className="text-6xl mb-4 block">ğŸ”</span>
          <p className="font-semibold">No hay productos en esta categorÃ­a</p>
          <p className="text-yellow-200 mt-2">Prueba con otra categorÃ­a</p>
        </div>
      )}

      {isCartOpen && (
        <Cart
          cartItems={cartItems}
          onClose={toggleCart}
          onRemoveItem={removeItem}
          onClearCart={clearCart}
          onIncreaseQty={increaseQty}
          onDecreaseQty={decreaseQty}
          onConfirmSale={confirmSale} // Nueva prop para confirmar venta
        />
      )}

      {notification && (
        <NotificationPopup 
          message={notification.message} 
          type={notification.type}
          onHide={hideNotification} 
        />
      )}
      <SocialButtons />
    </main>
  );
}